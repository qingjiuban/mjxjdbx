<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>点单</title>
<style>
  body { font-family: "微软雅黑", sans-serif; margin: 0; padding: 0; background: #f8f8f8; }
  .container { max-width: 500px; margin: 0 auto; background: #fff; display: flex; flex-direction: column; height: 100vh; }

  /* 订单列表（最大化） */
  .orders-section { flex: 1; overflow-y: auto; padding: 5px; }
  .order-item { display: flex; align-items: center; justify-content: center; padding: 3px 5px; background: #f9f9f9; margin-bottom: 2px; border-radius: 5px; position: relative; min-height: 34px; }
  
  /* 大字整体居中（进一步缩小） */
  .noodles-wrapper { display: flex; justify-content: center; align-items: center; }
  .noodles { font-size: 1.4em; font-weight: bold; letter-spacing: 8px; text-align: center; }

  .delete-btn { position: absolute; top: 2px; right: 2px; font-size: 1.3em; background: none; border: none; color: #ff4444; cursor: pointer; }

  /* 输入区（最小） */
  .input-section { flex-shrink: 0; padding: 8px; background: #fff; border-top: 1px solid #eee; }

  /* 堂食/外卖/打包 */
  .eat-group { display: flex; gap: 8px; margin-bottom: 8px; }
  .eat-btn { flex: 1; height: 60px; border-radius: 50%; font-size: 1.3em; font-weight: bold; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .eat-btn.active { box-shadow: 0 0 10px rgba(0,0,0,0.4); transform: scale(1.08); }
  .eat-tang { background: #4CAF50; }
  .eat-wai { background: #f44336; }
  .eat-daobao { background: #FFEB3B; color: black; }

  /* 宽面/细面 */
  .noodle-group { display: flex; gap: 10px; margin-bottom: 8px; }
  .noodle-btn { flex: 1; height: 60px; border-radius: 50%; font-size: 1.3em; border: 3px solid #ddd; background: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; }
  .noodle-btn.active { border-color: #4CAF50; background: #f0fff0; transform: scale(1.08); }

  /* 数量 */
  .quantity-control { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; justify-content: center; }
  .quantity-control button { width: 40px; height: 40px; font-size: 1.4em; background: #2196F3; color: white; border: none; border-radius: 50%; }
  .quantity-display { font-size: 1.5em; min-width: 45px; text-align: center; }

  /* 操作按钮 */
  .action-buttons { display: flex; gap: 8px; }
  .action-buttons button { flex: 1; padding: 8px; font-size: 0.9em; color: white; border: none; border-radius: 8px; font-weight: bold; }
  .add-btn { background: #4CAF50; font-size: 1.1em; }
  .clear-btn { background: #f44336; }
  .global-btn { background: #2196F3; }
  /* 只加这一个按钮 */
  .save-btn { background: #9C27B0; }
</style>
</head>
<body>
<div class="container">
  <div class="orders-section" id="orderList"></div>
  
  <div class="input-section">
    <div class="eat-group">
      <button class="eat-btn eat-tang active" data-value="堂食">堂食</button>
      <button class="eat-btn eat-wai" data-value="外卖">外卖</button>
      <button class="eat-btn eat-daobao" data-value="打包">打包</button>
    </div>
    
    <div class="noodle-group">
      <button class="noodle-btn active" data-value="宽面">宽面</button>
      <button class="noodle-btn" data-value="细面">细面</button>
    </div>
    
    <div class="quantity-control">
      <button onclick="changeQty(-1)">−</button>
      <div class="quantity-display" id="quantity">1</div>
      <button onclick="changeQty(1)">+</button>
    </div>
    
    <div class="action-buttons">
      <button class="add-btn" onclick="addOrder()">添加</button>
      <button class="clear-btn" onclick="clearOrders()">清空</button>
      <button class="global-btn" onclick="globalModify()">改所有</button>
      <!-- 只加这一个按钮，用于上传到数据库 -->
      <button class="save-btn" onclick="saveToSupabase()">保存到数据库</button>
    </div>
  </div>
</div>

<!-- 只加这一行 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
let currentType = "堂食";
let currentQty = 1;

document.querySelectorAll('.eat-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.eat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentType = btn.dataset.value;
  });
});

document.querySelectorAll('.noodle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('active');
  });
});

function changeQty(delta) {
  currentQty = Math.max(1, currentQty + delta);
  document.getElementById('quantity').textContent = currentQty;
}

function addOrder() {
  if (currentQty < 1) return;
  
  const wideActive = document.querySelector('.noodle-btn[data-value="宽面"]').classList.contains('active');
  const narrowActive = document.querySelector('.noodle-btn[data-value="细面"]').classList.contains('active');
  
  if (!wideActive && !narrowActive) {
    alert("请至少选择一种面条");
    return;
  }
  
  let noodlesStr = '';
  if (wideActive) noodlesStr += '宽'.repeat(currentQty);
  if (narrowActive) noodlesStr += '细'.repeat(currentQty);
  
  let typeText = '';
  if (currentType === "堂食") typeText = '<span style="color:#4CAF50">堂 </span>';
  else if (currentType === "外卖") typeText = '<span style="color:#f44336">外 </span>';
  else typeText = '<span style="color:#FFEB3B">打 </span>';
  
  const fullText = typeText + noodlesStr;
  
  const orderDiv = document.createElement("div");
  orderDiv.className = "order-item";
  
  orderDiv.innerHTML = `
    <div class="noodles-wrapper">
      <div class="noodles">${fullText}</div>
    </div>
    <button class="delete-btn" onclick="this.parentElement.remove();">×</button>
  `;
  
  document.getElementById("orderList").appendChild(orderDiv);
  
  currentQty = 1;
  document.getElementById('quantity').textContent = 1;
}

function clearOrders() {
  if (confirm("确定清空所有订单？")) {
    document.getElementById("orderList").innerHTML = "";
  }
}

function globalModify() {
  if (currentQty < 1) return;
  
  const wideActive = document.querySelector('.noodle-btn[data-value="宽面"]').classList.contains('active');
  const narrowActive = document.querySelector('.noodle-btn[data-value="细面"]').classList.contains('active');
  
  if (!wideActive && !narrowActive) {
    alert("请至少选择一种面条");
    return;
  }
  
  let noodlesStr = '';
  if (wideActive) noodlesStr += '宽'.repeat(currentQty);
  if (narrowActive) noodlesStr += '细'.repeat(currentQty);
  
  let typeText = '';
  if (currentType === "堂食") typeText = '<span style="color:#4CAF50">堂 </span>';
  else if (currentType === "外卖") typeText = '<span style="color:#f44336">外 </span>';
  else typeText = '<span style="color:#FFEB3B">打 </span>';
  
  const fullText = typeText + noodlesStr;
  
  const orders = document.getElementById("orderList").children;
  for (let item of orders) {
    item.innerHTML = `
      <div class="noodles-wrapper">
        <div class="noodles">${fullText}</div>
      </div>
      <button class="delete-btn" onclick="this.parentElement.remove();">×</button>
    `;
  }
}

// ================ 只加这个函数 ================
async function saveToSupabase() {
  // 获取所有订单
  const orderItems = document.getElementById("orderList").children;
  if (orderItems.length === 0) {
    alert("没有订单可保存");
    return;
  }
  
  // 初始化 Supabase
  const supabaseUrl = 'https://jfaxvecohlmgbscebujq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmYXh2ZWNvaGxtZ2JzY2VidWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODA0NDAsImV4cCI6MjA4MTU1NjQ0MH0.jW0SSkeiNqoDN8ywe45lnaDEnw6X3BUjcjfhxsnxy04';
  
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
  
  // 收集所有订单数据
  const ordersToSave = [];
  for (let item of orderItems) {
    const text = item.querySelector('.noodles').textContent;
    ordersToSave.push({
      order_text: text,
      created_at: new Date().toISOString()
    });
  }
  
  try {
    // 保存到数据库
    const { error } = await supabaseClient
      .from('orders')
      .insert(ordersToSave);
    
    if (error) throw error;
    
    alert(`成功保存 ${ordersToSave.length} 个订单到数据库`);
  } catch (error) {
    console.error('保存失败:', error);
    alert('保存失败，请检查数据库表是否存在\n\n请在Supabase中创建表：\nCREATE TABLE orders (\n  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  order_text TEXT NOT NULL\n);');
  }
}
</script>
</body>
</html>