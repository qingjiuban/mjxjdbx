<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>点单</title>

<style>
body {
  font-family: "微软雅黑", sans-serif;
  margin: 0;
  background: #f8f8f8;
}
.container {
  max-width: 500px;
  margin: 0 auto;
  background: #fff;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
.orders-section {
  flex: 1;
  overflow-y: auto;
  padding: 5px;
}
.order-item {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 3px 5px;
  background: #f9f9f9;
  margin-bottom: 2px;
  border-radius: 5px;
  position: relative;
  min-height: 34px;
}
.noodles-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
}
.noodles {
  font-size: 1.4em;
  font-weight: bold;
  letter-spacing: 8px;
}
.delete-btn {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 1.3em;
  background: none;
  border: none;
  color: #ff4444;
  cursor: pointer;
}

.input-section {
  padding: 8px;
  border-top: 1px solid #eee;
}
.eat-group,
.noodle-group {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}
.eat-btn,
.noodle-btn {
  flex: 1;
  height: 60px;
  border-radius: 50%;
  font-size: 1.3em;
  font-weight: bold;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.eat-btn.active,
.noodle-btn.active {
  transform: scale(1.08);
}
.eat-tang { background: #4CAF50; color: #fff; }
.eat-wai { background: #f44336; color: #fff; }
.eat-daobao { background: #FFEB3B; color: #000; }

.noodle-btn {
  border: 3px solid #ddd;
  background: #fff;
}
.noodle-btn.active {
  border-color: #4CAF50;
  background: #f0fff0;
}

.quantity-control {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.quantity-control button {
  width: 40px;
  height: 40px;
  font-size: 1.4em;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 50%;
}
.quantity-display {
  font-size: 1.5em;
  min-width: 45px;
  text-align: center;
}

.action-buttons {
  display: flex;
  gap: 8px;
}
.action-buttons button {
  flex: 1;
  padding: 8px;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  color: #fff;
}
.add-btn { background: #4CAF50; }
.clear-btn { background: #f44336; }
.global-btn { background: #2196F3; }

.status {
  font-size: 7px;
  text-align: center;
  padding: 2px;
  color: #999;
}
.status.connected { color: #4CAF50; }
.status.error { color: #f44336; }
</style>
</head>

<body>
<div class="container">

  <div class="orders-section" id="orderList"></div>

  <div class="input-section">
    <div class="eat-group">
      <button class="eat-btn eat-tang active" data-value="堂食">堂食</button>
      <button class="eat-btn eat-wai" data-value="外卖">外卖</button>
      <button class="eat-btn eat-daobao" data-value="打包">打包</button>
    </div>

    <div class="noodle-group">
      <button class="noodle-btn active" data-value="宽面">宽面</button>
      <button class="noodle-btn" data-value="细面">细面</button>
    </div>

    <div class="quantity-control">
      <button onclick="changeQty(-1)">−</button>
      <div class="quantity-display" id="quantity">1</div>
      <button onclick="changeQty(1)">+</button>
    </div>

    <div class="action-buttons">
      <button class="add-btn" onclick="addOrder()">添加</button>
      <button class="clear-btn" onclick="clearOrders()">清空</button>
      <button class="global-btn" onclick="globalModify()">改所有</button>
      <button class="global-btn" onclick="submitOrdersToSupabase()">提交</button>
    </div>
  </div>

  <div class="status" id="status">连接中…</div>
</div>

<script>
/* ===== Supabase 配置 ===== */
const SUPABASE_URL = 'https://jfaxvecohlmgbscebujq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmYXh2ZWNvaGxtZ2JzY2VidWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODA0NDAsImV4cCI6MjA4MTU1NjQ0MH0.jW0SSkeiNqoDN8ywe45lnaDEnw6X3BUjcjfhxsnxy04';

/* ===== 状态 ===== */
let currentType = '堂食';
let currentNoodle = '宽面';
let currentQty = 1;
let orders = [];

/* ===== 初始化 ===== */
window.onload = function () {
  bindButtons();
  checkConnection();
  setInterval(checkConnection, 30000);
};

/* ===== Supabase 连接检测 ===== */
async function checkConnection() {
  updateStatus('连接中…');
  try {
    const res = await fetch(SUPABASE_URL + '/auth/v1/settings', {
      headers: { apikey: SUPABASE_KEY }
    });
    updateStatus(
      res.ok ? '✓ Supabase 已连接' : '✗ 连接失败',
      res.ok ? 'connected' : 'error'
    );
  } catch {
    updateStatus('✗ 网络错误', 'error');
  }
}

function updateStatus(text, type) {
  const s = document.getElementById('status');
  s.textContent = text;
  s.className = 'status ' + (type || '');
}

/* ===== 交互 ===== */
function bindButtons() {
  document.querySelectorAll('.eat-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.eat-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentType = btn.dataset.value;
    };
  });

  document.querySelectorAll('.noodle-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.noodle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentNoodle = btn.dataset.value;
    };
  });
}

function changeQty(n) {
  currentQty = Math.max(1, currentQty + n);
  document.getElementById('quantity').textContent = currentQty;
}

function addOrder() {
  orders.push({
    type: currentType,
    noodle: currentNoodle,
    qty: currentQty
  });
  renderOrders();
}

function clearOrders() {
  orders = [];
  renderOrders();
}

function globalModify() {
  orders = orders.map(o => ({
    ...o,
    type: currentType,
    noodle: currentNoodle
  }));
  renderOrders();
}

function renderOrders() {
  const list = document.getElementById('orderList');
  list.innerHTML = '';
  orders.forEach((o, i) => {
    const d = document.createElement('div');
    d.className = 'order-item';
    d.innerHTML = `
      <div class="noodles-wrapper">
        <div class="noodles">${o.type} ${o.noodle} ×${o.qty}</div>
      </div>
      <button class="delete-btn" onclick="orders.splice(${i},1);renderOrders()">×</button>
    `;
    list.appendChild(d);
  });
}

/* ===== 写入 Supabase ===== */
async function submitOrdersToSupabase() {
  if (orders.length === 0) {
    alert('没有订单可提交');
    return;
  }

  const data = orders.map(o => ({
    type: o.type,
    noodle: o.noodle,
    qty: o.qty
  }));

  try {
    const res = await fetch(
      SUPABASE_URL + '/rest/v1/orders',
      {
        method: 'POST',
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: 'Bearer ' + SUPABASE_KEY,
          'Content-Type': 'application/json',
          Prefer: 'return=minimal'
        },
        body: JSON.stringify(data)
      }
    );

    if (res.ok) {
      alert('订单已写入数据库');
    } else {
      alert('写入失败：' + res.status);
    }
  } catch (e) {
    alert('网络错误，未写入数据库');
  }
}
</script>

</body>
</html>