<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>点单</title>
<style>
  body { font-family: "微软雅黑", sans-serif; margin: 0; padding: 0; background: #f8f8f8; }
  .container { max-width: 500px; margin: 0 auto; background: #fff; display: flex; flex-direction: column; height: 100vh; }

  /* 订单列表 */
  .orders-section { flex: 1; overflow-y: auto; padding: 5px; }
  .order-item { display: flex; align-items: center; justify-content: center; padding: 3px 5px; background: #f9f9f9; margin-bottom: 2px; border-radius: 5px; position: relative; min-height: 34px; }
  
  /* 大字整体居中 */
  .noodles-wrapper { display: flex; justify-content: center; align-items: center; }
  .noodles { font-size: 1.4em; font-weight: bold; letter-spacing: 8px; text-align: center; }

  .delete-btn { position: absolute; top: 2px; right: 2px; font-size: 1.3em; background: none; border: none; color: #ff4444; cursor: pointer; }

  /* 输入区 */
  .input-section { flex-shrink: 0; padding: 8px; background: #fff; border-top: 1px solid #eee; }

  /* 堂食/外卖/打包 */
  .eat-group { display: flex; gap: 8px; margin-bottom: 8px; }
  .eat-btn { flex: 1; height: 60px; border-radius: 50%; font-size: 1.3em; font-weight: bold; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .eat-btn.active { box-shadow: 0 0 10px rgba(0,0,0,0.4); transform: scale(1.08); }
  .eat-tang { background: #4CAF50; }
  .eat-wai { background: #f44336; }
  .eat-daobao { background: #FFEB3B; color: black; }

  /* 宽面/细面 */
  .noodle-group { display: flex; gap: 10px; margin-bottom: 8px; }
  .noodle-btn { flex: 1; height: 60px; border-radius: 50%; font-size: 1.3em; border: 3px solid #ddd; background: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; }
  .noodle-btn.active { border-color: #4CAF50; background: #f0fff0; transform: scale(1.08); }

  /* 数量 */
  .quantity-control { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; justify-content: center; }
  .quantity-control button { width: 40px; height: 40px; font-size: 1.4em; background: #2196F3; color: white; border: none; border-radius: 50%; }
  .quantity-display { font-size: 1.5em; min-width: 45px; text-align: center; }

  /* 操作按钮 */
  .action-buttons { display: flex; gap: 8px; }
  .action-buttons button { flex: 1; padding: 8px; font-size: 0.9em; color: white; border: none; border-radius: 8px; font-weight: bold; }
  .add-btn { background: #4CAF50; font-size: 1.1em; }
  .clear-btn { background: #f44336; }
  .global-btn { background: #2196F3; }
  
  /* 最小字状态 */
  .status { 
    font-size: 7px;  /* 更小的字 */
    text-align: center; 
    padding: 1px; 
    color: #999;
    letter-spacing: 0.3px;
    font-family: Arial, sans-serif;
    opacity: 0.7;
  }
  .status.connected { color: #4CAF50; }
  .status.error { color: #f44336; }
</style>
</head>
<body>
<div class="container">
  <div class="orders-section" id="orderList"></div>
  
  <div class="input-section">
    <div class="eat-group">
      <button class="eat-btn eat-tang active" data-value="堂食">堂食</button>
      <button class="eat-btn eat-wai" data-value="外卖">外卖</button>
      <button class="eat-btn eat-daobao" data-value="打包">打包</button>
    </div>
    
    <div class="noodle-group">
      <button class="noodle-btn active" data-value="宽面">宽面</button>
      <button class="noodle-btn" data-value="细面">细面</button>
    </div>
    
    <div class="quantity-control">
      <button onclick="changeQty(-1)">−</button>
      <div class="quantity-display" id="quantity">1</div>
      <button onclick="changeQty(1)">+</button>
    </div>
    
    <div class="action-buttons">
      <button class="add-btn" onclick="addOrder()">添加</button>
      <button class="clear-btn" onclick="clearOrders()">清空</button>
      <button class="global-btn" onclick="globalModify()">改所有</button>
    </div>
  </div>
  
  <!-- 最小字状态 -->
  <div class="status" id="status">连接中...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// 配置 - 检查URL和KEY是否正确
const SUPABASE_URL = 'https://jfaxvecohlmgbscebujq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmYXh2ZWNvaGxtZ2JzY2VidWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODA0NDAsImV4cCI6MjA4MTU1NjQ0MH0.jW0SSkeiNqoDN8ywe45lnaDEnw6X3BUjcjfhxsnxy04';

// 初始化Supabase客户端
let supabase;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
} catch (error) {
  console.error('初始化Supabase失败:', error);
  updateStatus('初始化失败', 'error');
}

// 变量
let currentType = "堂食";
let currentQty = 1;

// 初始化 - 简化版本
window.onload = function() {
  // 立即检查连接
  checkConnection();
  
  // 每30秒检查一次连接
  setInterval(checkConnection, 30000);
};

// 更简单的连接检测 - 不依赖表是否存在
async function checkConnection() {
  // 先显示连接中
  updateStatus('连接中...');
  
  try {
    // 使用更简单的检查方法：发送一个简单的查询
    // 即使表不存在，Supabase也会响应
    const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`
      }
    });
    
    if (response.ok) {
      updateStatus('✓ 已连接', 'connected');
      return true;
    } else {
      updateStatus('✗ 连接失败', 'error');
      return false;
    }
  } catch (error) {
    console.log('连接错误:', error.message);
    updateStatus('✗ 网络错误', 'error');
    return false;
  }
}

// 更新状态
function updateStatus(message, type = '') {
  const status = document.getElementById('status');
  if (status) {
    status.textContent = message;
    status.className = 'status';
    if (type) status.classList.add(type);
  }
}

// 保存订单到数据库 - 静默失败，不阻塞UI
async function autoSaveOrder(fullText) {
  if (!supabase) return;
  
  try {
    // 简单的插入操作
    const { error } = await supabase
      .from('orders')
      .insert({
        order_text: fullText,
        created_at: new Date().toISOString()
      });
    
    if (error) {
      // 如果是表不存在错误，显示提示
      if (error.message.includes('does not exist')) {
        console.log('表不存在，请在Supabase中创建orders表');
        updateStatus('✗ 表不存在', 'error');
      }
    } else {
      console.log('订单已保存');
    }
  } catch (error) {
    // 静默失败，不影响使用
    console.log('保存失败（不影响使用）');
  }
}

// 事件监听
document.querySelectorAll('.eat-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.eat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentType = btn.dataset.value;
  });
});

document.querySelectorAll('.noodle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('active');
  });
});

function changeQty(delta) {
  currentQty = Math.max(1, currentQty + delta);
  document.getElementById('quantity').textContent = currentQty;
}

// 添加订单
function addOrder() {
  if (currentQty < 1) return;
  
  const wideActive = document.querySelector('.noodle-btn[data-value="宽面"]').classList.contains('active');
  const narrowActive = document.querySelector('.noodle-btn[data-value="细面"]').classList.contains('active');
  
  if (!wideActive && !narrowActive) {
    alert("请至少选择一种面条");
    return;
  }
  
  let noodlesStr = '';
  if (wideActive) noodlesStr += '宽'.repeat(currentQty);
  if (narrowActive) noodlesStr += '细'.repeat(currentQty);
  
  let typeText = '';
  if (currentType === "堂食") typeText = '<span style="color:#4CAF50">堂 </span>';
  else if (currentType === "外卖") typeText = '<span style="color:#f44336">外 </span>';
  else typeText = '<span style="color:#FFEB3B">打 </span>';
  
  const fullText = typeText + noodlesStr;
  
  // 创建订单元素
  const orderDiv = document.createElement("div");
  orderDiv.className = "order-item";
  
  orderDiv.innerHTML = `
    <div class="noodles-wrapper">
      <div class="noodles">${fullText}</div>
    </div>
    <button class="delete-btn" onclick="this.parentElement.remove();">×</button>
  `;
  
  document.getElementById("orderList").appendChild(orderDiv);
  
  // 自动保存到数据库（静默）
  autoSaveOrder(fullText);
  
  // 重置
  currentQty = 1;
  document.getElementById('quantity').textContent = 1;
}

function clearOrders() {
  if (confirm("确定清空所有订单？")) {
    document.getElementById("orderList").innerHTML = "";
  }
}

function globalModify() {
  if (currentQty < 1) return;
  
  const wideActive = document.querySelector('.noodle-btn[data-value="宽面"]').classList.contains('active');
  const narrowActive = document.querySelector('.noodle-btn[data-value="细面"]').classList.contains('active');
  
  if (!wideActive && !narrowActive) {
    alert("请至少选择一种面条");
    return;
  }
  
  let noodlesStr = '';
  if (wideActive) noodlesStr += '宽'.repeat(currentQty);
  if (narrowActive) noodlesStr += '细'.repeat(currentQty);
  
  let typeText = '';
  if (currentType === "堂食") typeText = '<span style="color:#4CAF50">堂 </span>';
  else if (currentType === "外卖") typeText = '<span style="color:#f44336">外 </span>';
  else typeText = '<span style="color:#FFEB3B">打 </span>';
  
  const fullText = typeText + noodlesStr;
  
  const orders = document.getElementById("orderList").children;
  for (let item of orders) {
    item.innerHTML = `
      <div class="noodles-wrapper">
        <div class="noodles">${fullText}</div>
      </div>
      <button class="delete-btn" onclick="this.parentElement.remove();">×</button>
    `;
  }
}
</script>
</body>
</html>