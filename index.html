<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>点单系统 (自动同步)</title>
<style>
  body { font-family: "微软雅黑", sans-serif; margin: 0; padding: 0; background: #f8f8f8; }
  .container { max-width: 500px; margin: 0 auto; background: #fff; display: flex; flex-direction: column; height: 100vh; }

  /* 订单列表 */
  .orders-section { flex: 1; overflow-y: auto; padding: 5px; }
  .order-item { display: flex; align-items: center; justify-content: center; padding: 3px 5px; background: #f9f9f9; margin-bottom: 2px; border-radius: 5px; position: relative; min-height: 32px; }
  
  /* 订单文本 */
  .noodles-wrapper { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    width: 100%;
    padding: 0 5px;
  }
  .noodles { 
    font-size: 1.1em; 
    font-weight: bold; 
    letter-spacing: 5px; 
    text-align: center;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  /* 堂/外/打 圆形标签 */
  .type-tag {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    font-size: 0.8em;
    font-weight: bold;
    margin-right: 5px;
  }
  
  /* 不同类型标签的颜色 */
  .type-tang {
    background-color: #2E7D32;
    color: white;
  }
  .type-wai {
    background-color: #C62828;
    color: white;
  }
  .type-daobao {
    background-color: #F57C00;
    color: white;
  }

  .delete-btn { 
    position: absolute; 
    top: 50%; 
    right: 2px; 
    transform: translateY(-50%);
    font-size: 1.3em; 
    background: none; 
    border: none; 
    color: #ff4444; 
    cursor: pointer; 
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* 输入区 */
  .input-section { 
    flex-shrink: 0; 
    padding: 6px 8px 8px 8px;
    background: #fff; 
    border-top: 1px solid #eee; 
  }

  /* 堂食/外卖/打包 - 按钮样式 */
  .eat-group { display: flex; gap: 8px; margin-bottom: 6px; }
  .eat-btn { 
    flex: 1; 
    height: 60px; 
    border-radius: 50%; 
    font-size: 1.3em; 
    font-weight: bold; 
    color: white; 
    border: none; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s;
  }
  .eat-btn.active { 
    box-shadow: 0 0 12px rgba(0,0,0,0.5); 
    transform: scale(1.05);
  }
  .eat-tang { background: #4CAF50; }
  .eat-wai { background: #f44336; }
  .eat-daobao { background: #FFEB3B; color: black; }

  /* 宽面/细面 - 简化按钮样式（没有边框，直接加深颜色） */
  .noodle-group { display: flex; gap: 10px; margin-bottom: 6px; }
  .noodle-btn { 
    flex: 1; 
    height: 60px; 
    border-radius: 50%; 
    font-size: 1.3em; 
    font-weight: bold; 
    border: none; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: all 0.2s;
  }
  /* 默认状态 - 浅色 */
  .noodle-wide { 
    background: rgba(76, 175, 80, 0.3); /* 浅绿色 */
    color: #2E7D32; /* 深绿色文字 */
  }
  .noodle-narrow { 
    background: rgba(33, 150, 243, 0.3); /* 浅蓝色 */
    color: #1565C0; /* 深蓝色文字 */
  }
  /* 选中状态 - 颜色加深，有阴影 */
  .noodle-wide.active { 
    background: #4CAF50; /* 深绿色 */
    color: white;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    transform: scale(1.05);
  }
  .noodle-narrow.active { 
    background: #2196F3; /* 深蓝色 */
    color: white;
    box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
    transform: scale(1.05);
  }

  /* 数量 */
  .quantity-control { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; justify-content: center; }
  .quantity-control button { 
    width: 40px; 
    height: 40px; 
    font-size: 1.4em; 
    background: #2196F3; 
    color: white; 
    border: none; 
    border-radius: 50%; 
    cursor: pointer;
  }
  .quantity-display { font-size: 1.5em; min-width: 45px; text-align: center; }

  /* 操作按钮 */
  .action-buttons { display: flex; gap: 8px; }
  .action-buttons button { 
    flex: 1; 
    padding: 10px; 
    font-size: 1em; 
    color: white; 
    border: none; 
    border-radius: 10px; 
    font-weight: bold; 
    cursor: pointer;
    transition: all 0.2s;
  }
  .action-buttons button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .add-btn { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
  .clear-btn { background: linear-gradient(135deg, #f44336, #C62828); }

  /* 数据库连接状态栏 - 最小化 */
  .db-status { 
    position: fixed; 
    bottom: 2px; 
    left: 2px; 
    background: rgba(0,0,0,0.6); 
    color: white; 
    padding: 1px 4px; 
    font-size: 0.55em; 
    border-radius: 2px;
    z-index: 1000;
    max-width: 120px;
    overflow: hidden;
    white-space: nowrap;
  }
  
  .status-connecting { color: #FFA500; }
  .status-connected { color: #4CAF50; }
  .status-error { color: #f44336; }
  
  /* 时间显示 */
  .order-time {
    position: absolute;
    bottom: 2px;
    left: 5px;
    font-size: 0.6em;
    color: #999;
  }
</style>
</head>
<body>
<div class="container">
  <div class="orders-section" id="orderList"></div>
  
  <div class="input-section">
    <div class="eat-group">
      <button class="eat-btn eat-tang active" data-value="堂食">堂食</button>
      <button class="eat-btn eat-wai" data-value="外卖">外卖</button>
      <button class="eat-btn eat-daobao" data-value="打包">打包</button>
    </div>
    
    <!-- 修改：去掉方框选择，直接是按钮，通过颜色深浅表示选中 -->
    <div class="noodle-group">
      <button class="noodle-btn noodle-wide active" data-value="宽面">宽面</button>
      <button class="noodle-btn noodle-narrow active" data-value="细面">细面</button>
    </div>
    
    <div class="quantity-control">
      <button onclick="changeQty(-1)">−</button>
      <div class="quantity-display" id="quantity">1</div>
      <button onclick="changeQty(1)">+</button>
    </div>
    
    <div class="action-buttons">
      <button class="add-btn" onclick="addOrder()">添加</button>
      <button class="clear-btn" onclick="clearOrders()">清空列表</button>
    </div>
  </div>
</div>

<!-- 数据库连接状态 -->
<div class="db-status" id="dbStatus">
  <span id="statusText">正在连接...</span>
</div>

<!-- 引入 Supabase 客户端 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>

<script>
// ========== Supabase 配置 ==========
const SUPABASE_URL = 'https://jfaxvecohlmgbscebujq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmYXh2ZWNvaGxtZ2JzY2VidWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODA0NDAsImV4cCI6MjA4MTU1NjQ0MH0.jW0SSkeiNqoDN8ywe45lnaDEnw6X3BUjcjfhxsnxy04';

// 初始化 Supabase 客户端
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ========== 全局变量 ==========
let currentType = "堂食";
let currentQty = 1;
let isDbConnected = false;

// ========== 数据库连接状态检查 ==========
async function checkDbConnection() {
  const statusElement = document.getElementById('statusText');
  
  try {
    statusElement.textContent = "连接中...";
    statusElement.className = "status-connecting";
    
    const { data, error } = await supabase
      .from('orders')
      .select('id')
      .limit(1);
    
    if (error) {
      console.error('数据库连接错误:', error);
      statusElement.textContent = `连接失败`;
      statusElement.className = "status-error";
      isDbConnected = false;
    } else {
      statusElement.textContent = "✓ 已连接";
      statusElement.className = "status-connected";
      isDbConnected = true;
    }
  } catch (error) {
    console.error('数据库连接异常:', error);
    statusElement.textContent = `连接异常`;
    statusElement.className = "status-error";
    isDbConnected = false;
  }
}

// ========== 自动同步到数据库 ==========
async function syncOrderToDatabase(orderData) {
  if (!isDbConnected) {
    console.warn('数据库未连接，订单将不会保存');
    return null;
  }
  
  try {
    orderData.created_at = new Date().toISOString();
    orderData.is_active = true;
    
    const { data, error } = await supabase
      .from('orders')
      .insert([orderData])
      .select();
    
    if (error) {
      console.error('保存订单失败:', error);
      updateDbStatus(`保存失败`, 'error');
      return null;
    }
    
    console.log('订单已保存到数据库');
    return data[0];
  } catch (error) {
    console.error('同步订单异常:', error);
    updateDbStatus(`同步异常`, 'error');
    return null;
  }
}

// ========== 从数据库加载最近5分钟内的订单 ==========
async function loadRecentOrders() {
  try {
    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
    
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .gte('created_at', fiveMinutesAgo)
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('加载订单失败:', error);
      return [];
    }
    
    console.log('加载了', data.length, '个最近5分钟的订单');
    return data || [];
  } catch (error) {
    console.error('加载订单异常:', error);
    return [];
  }
}

// ========== 显示订单到前端 ==========
function displayOrders(orders) {
  const orderList = document.getElementById('orderList');
  orderList.innerHTML = '';
  
  orders.forEach(order => {
    const orderDiv = createOrderElement(order);
    orderList.appendChild(orderDiv);
  });
}

// ========== 创建订单元素 ==========
function createOrderElement(order) {
  const orderDiv = document.createElement("div");
  orderDiv.className = "order-item";
  orderDiv.dataset.orderId = order.id;
  
  const orderType = order.order_type || '堂食';
  const noodleType = order.noodle_type || { wide: true, narrow: false };
  const quantity = order.quantity || 1;
  const createdAt = order.created_at ? new Date(order.created_at) : new Date();
  
  // 生成面条文本
  let noodlesStr = '';
  if (noodleType.wide) noodlesStr += '宽'.repeat(quantity);
  if (noodleType.narrow) noodlesStr += '细'.repeat(quantity);
  
  // 生成类型标签
  let typeTagClass = '';
  let typeTagText = '';
  if (orderType === "堂食") {
    typeTagClass = 'type-tang';
    typeTagText = '堂';
  } else if (orderType === "外卖") {
    typeTagClass = 'type-wai';
    typeTagText = '外';
  } else {
    typeTagClass = 'type-daobao';
    typeTagText = '打';
  }
  
  // 格式化时间
  const timeStr = `${createdAt.getHours().toString().padStart(2, '0')}:${createdAt.getMinutes().toString().padStart(2, '0')}`;
  
  orderDiv.innerHTML = `
    <div class="noodles-wrapper">
      <div class="noodles">
        <span class="type-tag ${typeTagClass}">${typeTagText}</span>
        ${noodlesStr}
      </div>
      <div class="order-time">${timeStr}</div>
    </div>
    <button class="delete-btn" onclick="removeOrderFromUI(this)">×</button>
  `;
  
  return orderDiv;
}

// ========== 从前端移除订单 ==========
function removeOrderFromUI(button) {
  const orderElement = button.parentElement;
  orderElement.remove();
  updateDbStatus('已移除', 'info');
}

// ========== 更新数据库状态显示 ==========
function updateDbStatus(message, type = 'info') {
  const statusElement = document.getElementById('statusText');
  statusElement.textContent = message;
  
  switch(type) {
    case 'connected':
      statusElement.className = "status-connected";
      break;
    case 'error':
      statusElement.className = "status-error";
      break;
    case 'connecting':
      statusElement.className = "status-connecting";
      break;
    default:
      statusElement.className = "";
  }
  
  if (type === 'error' || type === 'info') {
    setTimeout(() => {
      if (isDbConnected) {
        updateDbStatus("✓ 已连接", 'connected');
      } else {
        updateDbStatus("连接失败", 'error');
      }
    }, 2000);
  }
}

// ========== 前端点单逻辑 ==========
// 堂食/外卖/打包选择
document.querySelectorAll('.eat-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.eat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentType = btn.dataset.value;
  });
});

// 宽面/细面选择 - 简化操作，点击切换选中状态
document.querySelectorAll('.noodle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('active');
  });
});

function changeQty(delta) {
  currentQty = Math.max(1, currentQty + delta);
  document.getElementById('quantity').textContent = currentQty;
}

// ========== 添加订单 ==========
async function addOrder() {
  if (currentQty < 1) return;
  
  const wideActive = document.querySelector('.noodle-btn[data-value="宽面"]').classList.contains('active');
  const narrowActive = document.querySelector('.noodle-btn[data-value="细面"]').classList.contains('active');
  
  if (!wideActive && !narrowActive) {
    alert("请至少选择一种面条");
    return;
  }
  
  // 准备数据库数据
  const orderData = {
    order_type: currentType,
    noodle_type: {
      wide: wideActive,
      narrow: narrowActive
    },
    quantity: currentQty,
    display_text: generateDisplayText(currentType, wideActive, narrowActive, currentQty)
  };
  
  // 先添加到前端显示
  const tempOrder = {
    id: 'temp_' + Date.now(),
    order_type: currentType,
    noodle_type: { wide: wideActive, narrow: narrowActive },
    quantity: currentQty,
    created_at: new Date().toISOString()
  };
  
  const orderDiv = createOrderElement(tempOrder);
  document.getElementById("orderList").appendChild(orderDiv);
  
  // 自动同步到数据库
  syncOrderToDatabase(orderData).then(dbOrder => {
    if (dbOrder && dbOrder.id) {
      orderDiv.dataset.orderId = dbOrder.id;
      orderDiv.classList.add('synced');
      updateDbStatus('已保存', 'connected');
    }
  });
  
  // 滚动到最新订单
  orderDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  // 重置数量
  currentQty = 1;
  document.getElementById('quantity').textContent = 1;
}

// ========== 生成显示文本 ==========
function generateDisplayText(type, wide, narrow, qty) {
  let text = type + ' ';
  if (wide) text += '宽'.repeat(qty);
  if (narrow) text += '细'.repeat(qty);
  return text;
}

// ========== 清空前端列表 ==========
function clearOrders() {
  if (confirm("确定清空前端所有订单？(数据库中的订单不会删除)")) {
    document.getElementById("orderList").innerHTML = "";
    updateDbStatus('已清空', 'info');
  }
}

// ========== 页面初始化 ==========
async function initPage() {
  await checkDbConnection();
  
  if (isDbConnected) {
    const recentOrders = await loadRecentOrders();
    displayOrders(recentOrders);
    updateDbStatus(`已加载 ${recentOrders.length} 个`, 'info');
  }
  
  setInterval(checkDbConnection, 30000);
  setInterval(async () => {
    if (isDbConnected) {
      const recentOrders = await loadRecentOrders();
      displayOrders(recentOrders);
    }
  }, 60000);
}

// ========== 页面加载完成后初始化 ==========
document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>